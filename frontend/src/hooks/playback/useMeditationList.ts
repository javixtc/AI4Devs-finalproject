/**
 * useMeditationList Hook
 * 
 * React Query hook for fetching user's meditation list.
 * 
 * Features:
 * - Auto-fetches on mount
 * - Caching with React Query
 * - Loading and error states
 * - Auto-refetch on window focus
 * - Type-safe with generated OpenAPI client
 * 
 * Server-State Management: React Query (NOT Zustand)
 */

import { useQuery } from '@tanstack/react-query';
import { Configuration, PlaybackApi, MeditationItem } from '../../api/generated/playback/src';
import { API_BASE_URL } from '../../config';
import { getAuthHeaders } from '../../api/authHeader';

/**
 * API Configuration
 * TODO: Replace with actual auth token from authentication context (US1)
 */
const getApiConfig = (): Configuration => {
  return new Configuration({
    basePath: `${API_BASE_URL}/api/v1`,
    headers: { ...getAuthHeaders() },
  });
};

/**
 * Fetches list of meditations from backend.
 * Uses autogenerated PlaybackApi client.
 */
const fetchMeditationList = async (): Promise<MeditationItem[]> => {
  const api = new PlaybackApi(getApiConfig());
  
  try {
    const response = await api.listUserMeditations({});
    return response.meditations || [];
  } catch (error) {
    console.error('Error fetching meditation list:', error);
    throw new Error('Could not load the meditation list');
  }
};

/**
 * useMeditationList Hook
 * 
 * Fetches and manages meditation list state using React Query.
 * 
 * @returns {object} React Query result with:
 *   - data: MeditationItem[] (meditation list)
 *   - isLoading: boolean
 *   - error: Error | null
 *   - refetch: () => void
 * 
 * @example
 * ```tsx
 * function MyComponent() {
 *   const { data: meditations, isLoading, error } = useMeditationList();
 *   
 *   if (isLoading) return <p>Loading...</p>;
 *   if (error) return <p>Error: {error.message}</p>;
 *   
 *   return <MeditationList meditations={meditations} />;
 * }
 * ```
 */
export const useMeditationList = () => {
  return useQuery({
    queryKey: ['meditations', 'list'],
    queryFn: fetchMeditationList,
    staleTime: 1000 * 60 * 5, // 5 minutes
    gcTime: 1000 * 60 * 10,    // 10 minutes (renamed from cacheTime in v5)
    refetchOnWindowFocus: true,
    retry: 2,
    // Convert Error to user-friendly error object
    throwOnError: false
  });
};

export default useMeditationList;
